---
title: 'Final Product'
author: "John Knight"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options("scipen" = 999)
```

<br>

# A Clever Title About Museum Grants

#### And a descriptive subtitle

<br>

------------------------------------------------------------------------

The Institute of Museum and Library Services (IMLS) is an independent agency of the federal government on a mission to, "advance, support, and empower America's museums libraries, and related organizations through grantmaking, research, and policy development."

The IMLS maintains a list of museums in the US in a set of files called the Museum Data Files (MDF). The MDF contain basic institutional identifying information for about 30,000 museums and related organizations in the US. They are split into three files using the following categories. The MDF was last updated in 2018.

The IMLS also makes available data regarding the grants they award to these institutions for various initiatives.

Here is a summary.

-   Placeholder

-   Placeholder

-   Placeholder

<br>

------------------------------------------------------------------------

<br>

### Total grants and programs

```{r include=FALSE}

library(tidyverse)
library(maps)

# import grant data (v2)
data_grants_raw <- read_csv("awarded-grants-2023-04-01 v2.csv")

# select columns to work with
data_grants <- data_grants_raw %>%
  select(institution,
         city,
         state,
         year,
         funds,
         program,
         `log number`
         )

# import MDF File 1 (v2), format select columns
data_museums_raw <- read_csv("MuseumFile2018_File1_Nulls v2.csv", 
                             col_types = cols(DISCIPL = col_factor(levels = c("ART", "BOT", 
                                                                              "CMU", "HST", 
                                                                              "NAT", "SCI", 
                                                                              "ZAW")), 
                                              TAXPER15 = col_date(format = "%Y%m"),
                                              INCOMECD15 = col_factor(levels = c("0", "1", 
                                                                                 "2", "3", 
                                                                                 "4", "5", 
                                                                                 "6", "7",
                                                                                 "8", "9")),
                                              AAMREG = col_factor(levels = c("1", "2", "3",
                                                                             "4", "5", "6")),
                                              BEAREG = col_factor(levels = c("1", "2", "3",
                                                                             "4", "5", "6",
                                                                             "7", "8")),
                                              LOCALE4 = col_factor(levels = c("1", "2", "3", 
                                                                              "4"))
                                              )
                             )

# select columns to work with
data_museums <- data_museums_raw %>%
  select(COMMONNAME,
         DISCIPL,
         INCOMECD15
         )

# join requires the same case for character strings
data_grants$institution <- tolower(data_grants$institution)
data_museums$COMMONNAME <- tolower(data_museums$COMMONNAME)

# join by name, inner join retains only matching rows, and filter for last 10 years
data <- data_grants %>%
  inner_join(data_museums,
            by = c("institution" = "COMMONNAME"),
            relationship = "many-to-many"
            ) %>%
  filter(year >= 2013)
```

<br>

How many grants did the IMLS award over the last 10 years and what was the total and average value?

```{r}

data %>%
  summarize(grants = n(),
            total_funds = sum(funds),
            mean_award = mean(funds)
            )
```

<br>

Funds over time.

```{r}

# plot of total funds each year
data %>%
  group_by(year) %>%
  summarize(funds = sum(funds)) %>%
  ggplot(aes(x = year,
             y = funds
             )
         ) +
  geom_line()
```

<br>

------------------------------------------------------------------------

<br>

### What institutions received grants?

<br>

How many different institutions won grants?

```{r}

data %>%
  count(institution, sort = TRUE) %>%
  summarize(institutions = n())
```

<br>

Did any institutions win multiple grants?

```{r}

# plot of number of grants
data %>%
  count(institution) %>%
  ggplot(aes(x = n)) +
  geom_bar()
```

<br>

Breakdown by state.

```{r eval=FALSE, include=FALSE}

# number of grants
data %>%
  group_by(state) %>%
  summarize(grants = n(),
            total_funds = sum(funds),
            mean_award = mean(funds)
            ) %>%
  arrange(-total_funds)
```

```{r include=FALSE}

# import state abbreviations
state_abbr <- read_csv("state_abbr.csv")

# change state name to lower case
state_abbr$state <- tolower(state_abbr$state)

# summarize data to state and total funds
grants_state <- data %>%
  group_by(state) %>%
  summarize(total_funds = sum(funds)) %>%
  rename(state_abbr = state) %>%
  left_join(state_abbr,
            by = c("state_abbr" = "abbreviation")
            )

# for map data (from R Graphics Cookbook)
states_map <- map_data("state")

# join
grants_map <- states_map %>%
  left_join(grants_state,
            by = c("region" = "state")
            )
```

```{r echo=FALSE}

# plot map
grants_map %>%
  ggplot(aes(x = long,
             y = lat,
             group = group,
             fill = total_funds
             )
         ) +
  geom_polygon(color = "black") +
  coord_map("mercator") +
  theme_void()
```

<br>

Total value of grants by discipline.

```{r eval=FALSE, include=FALSE}

# absolute funds
data %>%
  group_by(DISCIPL) %>%
  summarize(funds = sum(funds)) %>%
  arrange(-funds)
```

```{r}

# plot of absolute funds
data %>%
  group_by(DISCIPL) %>%
  summarize(funds = sum(funds)) %>%
  ggplot(aes(x = reorder(DISCIPL, -funds),
             y = funds,
             fill = DISCIPL
             )
         ) +
  geom_col()
```

<br>

------------------------------------------------------------------------

<br>

### What about in terms of income?

<br>

Total value of grants by IRS income category. 92 (15%) awarded institutions are missing values for this variable. Those institutions are not included in the graph below.

```{r eval=FALSE, include=FALSE}

# absolute funds
data %>%
  filter(!is.na(INCOMECD15)) %>%
  group_by(INCOMECD15) %>%
  summarize(funds = sum(funds)) %>%
  add_row(INCOMECD15 = as.factor(1),
          funds = 0
          ) %>%
  arrange(INCOMECD15)
```

```{r echo=FALSE}

# plot of absolute funds
data %>%
  filter(!is.na(INCOMECD15)) %>%
  group_by(INCOMECD15) %>%
  summarize(funds = sum(funds)) %>%
  add_row(INCOMECD15 = as.factor(1),
          funds = 0
          ) %>%
  ggplot(aes(x = INCOMECD15,
             y = funds
             )
         ) +
  geom_col()
```

<br>

------------------------------------------------------------------------

<br>

### Why did more grants go to institutions with higher incomes?

<br>

```{r}

data_not_awarded <- data_museums %>%
  full_join(data_grants, 
            by = c("COMMONNAME" = "institution"), 
            keep = TRUE,
            relationship = "many-to-many"
            ) %>%
  filter(!is.na(COMMONNAME)) %>%    # remove awarded institutions not in the museum list
  replace_na(list(year = 9999,      # replace NAs with values for analysis
                  funds = 0
                  )
             ) %>%
  mutate(awarded = if_else(funds > 0, TRUE, FALSE)) %>%
  filter(year >= 2013) %>%
  filter(awarded == FALSE)
```

<br>

How many institutions did not win an award over the last 10 years?

```{r}

data_not_awarded %>%
  summarize(count = n())
```

<br>

By income. 2,330 (35%) institutions are missing values for this variable. Those institutions are not included in the graph below.

```{r echo=FALSE}

# count not awarded
data_not_awarded_count <- data_not_awarded %>%
  filter(!is.na(INCOMECD15)) %>%
  group_by(INCOMECD15) %>%
  summarize(count = n()) %>%
  mutate(awarded = FALSE)

# print
data_not_awarded_count
```

```{r}

# plot of count not awarded
data_not_awarded_count %>%
  ggplot(aes(x = INCOMECD15,
             y = count
             )
         ) +
  geom_col()
```

<br>

```{r}

# count awarded
data_awarded_count <- data %>%
  filter(!is.na(INCOMECD15)) %>%
  group_by(institution) %>%
  slice_head() %>%
  ungroup() %>%
  group_by(INCOMECD15) %>%
  summarize(count = n()) %>%
  add_row(INCOMECD15 = as.factor(1),
          count = 0
          ) %>%
  mutate(awarded = TRUE) %>%
  arrange(INCOMECD15)

# print
data_awarded_count
```

```{r}

# plot of count awarded
data_awarded_count %>%
  ggplot(aes(x = INCOMECD15,
             y = count
             )
         ) +
  geom_col()
```

<br>

Combine awarded and not awarded in one chart.

```{r}

data_count <- data_awarded_count %>%
  bind_rows(data_not_awarded_count)
```

```{r}

data_count %>%
  ggplot(aes(x = INCOMECD15,
             y = count,
             fill = awarded
             )
         ) +
  geom_col(position = "dodge")

data_count %>%
  filter(INCOMECD15 != 0) %>%
  ggplot(aes(x = INCOMECD15,
             y = count,
             fill = awarded
             )
         ) +
  geom_col(position = "dodge")
```

<br>

------------------------------------------------------------------------

<br>

### Burden of matching funds

<br>

Grants by program.

```{r}

data %>%
  group_by(program) %>%
  summarize(count = n(),
            total_funds = sum(funds)
            ) %>%
  arrange(-total_funds) %>%
  mutate(proportion = (total_funds / sum(total_funds))*100)
```

<br>

-   Top 3 programs by funding represent 93% of total funds over the last 10 years

-   They require matching funds from non-federal sources

<br>

Median award by program by year, as percentage of that income category.

```{r}

# test with Museums for America only to start
# median grant value through Museums for America
data %>%
  filter(program == "Museums for America") %>%
  summarize(median_grant = median(funds)) 
```

```{r}

# create plot of income codes
income_codes <- tibble(
  code = as.factor(c(0:9)),
  low = c(0, 1, 10000, 25000, 100000, 500000, 1000000, 5000000, 10000000, 50000000),
  high = c(0, 9999, 24999, 99999, 499999, 999999, 4999999, 9999999, 49999999, 50000000)
) %>%
  mutate(mid = ((high - low)/2) + low,
         median_grant = 149967,
         ratio = mid/median_grant,
         percent = (median_grant/mid) * 100
         )

income_codes
```

```{r}

income_codes %>%
  filter(code == c(0, 1, 2, 3, 4)) %>%
  ggplot(aes(x = code,
             y = mid
             )
         ) +
  geom_col() +
  geom_point(aes(x = code,
                 y = median_grant
                 )
             )

income_codes %>%
  filter(code == c(0, 1, 2, 3, 4, 5)) %>%
  ggplot(aes(x = code,
             y = mid
             )
         ) +
  geom_col() +
  geom_point(aes(x = code,
                 y = median_grant
                 )
             )

income_codes %>%
  filter(code == c(0, 1, 2, 3, 4, 5, 6)) %>%
  ggplot(aes(x = code,
             y = mid
             )
         ) +
  geom_col() +
  geom_point(aes(x = code,
                 y = median_grant
                 )
             )

income_codes %>%
  ggplot(aes(x = code,
             y = mid
             )
         ) +
  geom_col() +
  geom_point(aes(x = code,
                 y = median_grant
                 )
             )
```

```{r}

# ration of income (mid) to median grant
income_codes %>%
  ggplot(aes(x = code,
             y = ratio
             )
         ) +
  geom_col()
```

<br>

------------------------------------------------------------------------

<br>

### Correlation to other socio-economic criteria

-   Use zip codes to compare to low-income areas (census bureau?)

<br>

------------------------------------------------------------------------

<br>

### Call to action

-   Access to museums improve outcomes

-   IMLS should direct more funding to areas that need it

-   People can donate to the least likely museums

<br>

------------------------------------------------------------------------

<br>

### Footnotes

1.  I don't know why the institutions did not receive a grant.
2.  INCOMECD15 used as benchmark for income even though it could be different before or after.
3.  Institutions may have received a grant in a different year than when their INCOMECD15 year

<br>

### Methodology

Placeholder.

<br>

### Sources

Placeholder.

<br>

```{r eval=FALSE, include=FALSE}

# SANDBOX

# unknown if museums that did not receive awards applied for grants

# institutions with more revenue/income can pay for staff who apply for grants

# impact of private/other funding on applying for grants, winning


# group or stacked col chart of awarded/not awarded by variables
```
